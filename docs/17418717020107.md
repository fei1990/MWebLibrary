# ç»„ä»¶åŒ–é€šè®¯æ–¹æ¡ˆ
æ‰€è°“çš„ç»„ä»¶åŒ–å°±æ˜¯æŠŠå„ä¸ªæ¨¡å—ä»¥ä¸åŒçš„é¡¹ç›®ç‹¬ç«‹å‡ºæ¥ï¼Œå†ç”±ä¸€ä¸ªç»Ÿä¸€çš„ä¸»å·¥ç¨‹è¿›è¡Œç®¡ç†ã€‚ç»„ä»¶åŒ…æ‹¬ä¸šåŠ¡ç»„ä»¶å’ŒåŠŸèƒ½ç»„ä»¶ï¼Œç»„ä»¶åŒ–è¦è§£å†³çš„æ ¸å¿ƒé—®é¢˜å°±æ˜¯ä¸šåŠ¡ç›´æ¥çš„é€šè®¯ä¹Ÿå°±æ˜¯å¦‚ä½•è·¯ç”±ã€‚å¸¸ç”¨çš„è·¯ç”±æœ‰ä¸‰ç§æ–¹æ¡ˆ
- [x] URL Scheme
- [x] Target - Action
- [x] Protocol - Class åŒ¹é…

## URL Schemeè·¯ç”±
URLè·¯ç”±çš„æ–¹å¼ä¸»è¦æ˜¯ä»¥è˜‘è‡è¡—ä¸ºä»£è¡¨çš„[MGJRouter](https://github.com/lyujunwei/MGJRouter)      
å…¶å®ç°æ€è·¯æ˜¯ï¼š
* Appå¯åŠ¨æ—¶å®ä¾‹åŒ–å„ç»„ä»¶æ¨¡å—ï¼Œç„¶åè¿™äº›ç»„ä»¶å‘`ModuleManager`æ³¨å†Œurl
* å½“ç»„ä»¶Aéœ€è¦è°ƒç”¨ç»„ä»¶Bæ—¶ï¼Œå‘`ModuleManger`ä¼ é€’URLï¼Œå‚æ•°ä»¥GETçš„å½¢å¼æ‹¼åœ¨URLä¸­ï¼Œç„¶åç”±`ModuleManager`è´Ÿè´£è°ƒèµ·Bç»„ä»¶ã€‚     
ä¸»è¦æ–¹æ³•å°±ä¸¤ä¸ªï¼š
```
// 1ã€æ³¨å†ŒæŸä¸ªURL
MGJRouter.registerURLPattern("app://home") { (info) in
    print("info: (info)")
}

//2ã€è°ƒç”¨è·¯ç”±
MGJRouter.openURL("app://home")
```
ç»„ä»¶æ³¨å†Œçš„æ—¶å€™å¯ä»¥åœ¨`didFinishLaunching`ä¸­ï¼Œä¹Ÿå¯ä»¥åœ¨`+load`æ–¹æ³•ä¸­ï¼Œéšç€ç»„ä»¶çš„å¢å¤šï¼Œ`didFinishLaunching`æ–¹æ³•ä¹Ÿå˜å¾—éå¸¸è‡ƒè‚¿ï¼Œ`+load`æ–¹æ³•ä½¿ç”¨ä¹Ÿä¼šå¢å¤šï¼Œæœ‰çš„å·¥ç¨‹ä¼šå¯¹`+load`æ–¹æ³•çš„ä½¿ç”¨æ•°é‡è¿›è¡Œé™åˆ¶ã€‚
### URLè·¯ç”±çš„ä¼˜ç‚¹
* çµæ´»æ€§ï¼Œé€‚åˆç»å¸¸å¼€å±•è¿è¥æ´»åŠ¨çš„appï¼Œä¾‹å¦‚ç”µå•†ã€‚
* æ–¹ä¾¿ç»Ÿä¸€ç®¡ç†å¤šå¹³å°çš„è·¯ç”±è§„åˆ™ã€‚
* æ˜“äºé€‚é…URL Scheme

### URLè·¯ç”±çš„ç¼ºç‚¹
* ä¼ å‚æ–¹å¼æœ‰é™ï¼Œæ‰€æœ‰çš„å‚æ•°éƒ½æ˜¯åœ¨urlå­—ç¬¦ä¸²ä¸­ï¼Œæ— æ³•åœ¨ç¼–è¯‘é˜¶æ®µåˆ©ç”¨ç¼–è¯‘å™¨è¿›è¡Œç±»å‹æ£€æŸ¥ã€‚
* ä¾èµ–äºå­—ç¬¦ä¸²ï¼ˆURLï¼‰ç¡¬ç¼–ç ï¼Œéš¾ä»¥ç®¡ç†ï¼Œéœ€è¦ä¸€ä¸ªç®¡ç†å¹³å°æˆ–è€…æ–‡æ¡£è¿›è¡Œç»Ÿä¸€çº¦æŸç®¡ç†ã€‚
* æ³¨å†Œæ–¹å¼å—é™ï¼Œæ— è®ºæ˜¯`didFinishLaunching`è¿˜æ˜¯`+load`éƒ½æœ‰æ˜æ˜¾çš„ç¼ºç‚¹ã€‚

## Target - Action
è¿™ä¸ªæ–¹æ¡ˆçš„ä¸»è¦ä»£è¡¨æ¡†æ¶å°±æ˜¯[CTMediator](https://github.com/casatwy/CTMediator)ï¼Œä¾‹å¦‚é€šè¿‡`NSClassFromString`è·å–ç±»å¹¶åˆ›å»ºå®ä¾‹ï¼Œé€šè¿‡`performSelector + NSInvocation`åŠ¨æ€è°ƒç”¨æ–¹æ³•ã€‚      
å…¶å®ç°æ€è·¯æ˜¯ï¼š
* åˆ©ç”¨åˆ†ç±»ä¸ºè·¯ç”±æ·»åŠ æ–°æ¥å£ï¼Œåœ¨æ¥å£ä¸­é€šè¿‡å­—ç¬¦ä¸²è·å–å¯¹åº”çš„ç±»
* é€šè¿‡runtimeåˆ›å»ºå®ä¾‹ï¼Œå¹¶è°ƒç”¨å®ä¾‹æ–¹æ³•ã€‚      

`CTMediator`çš„ç®€å•ä½¿ç”¨ï¼š
```
//******* 1ã€åˆ†ç±»å®šä¹‰æ–°æ¥å£
extension CTMediator{
    @objc func A_showHome()->UIViewController?{
    
        //åœ¨swiftä¸­ä½¿ç”¨æ—¶ï¼Œéœ€è¦ä¼ å…¥å¯¹åº”é¡¹ç›®çš„targetåç§°ï¼Œå¦åˆ™ä¼šæ‰¾ä¸åˆ°è§†å›¾æ§åˆ¶å™¨
        let params = [
            kCTMediatorParamsKeySwiftTargetModuleName: "CJLBase_Example"
        ]
        //CTMediatoræä¾›çš„performTarget:action:params:shouldCacheTarget:æ–¹æ³• é€šè¿‡ä¼ å…¥nameï¼Œæ‰¾åˆ°å¯¹åº”çš„targerå’Œaction
        if let vc = self.performTarget("A", action: "Extension_HomeViewController", params: params, shouldCacheTarget: false) as? UIViewController{
            return vc
        }
        return nil
    }
}

//******* 2ã€æ¨¡å—æä¾›è€…æä¾›target-actionçš„è°ƒç”¨æ–¹å¼ï¼ˆå¯¹å¤–éœ€è¦åŠ ä¸Špublicå…³é”®å­—ï¼‰
class Target_A: NSObject {
    
    @objc func Action_Extension_HomeViewController(_ params: [String: Any])->UIViewController{
         
        let home = HomeViewController()
        return home
    }

}

//******* 3ã€ä½¿ç”¨
if let vc = CTMediator.sharedInstance().A_showHome() {
            self.navigationController?.pushViewController(vc, animated: true)
        }

```
### ä¼˜ç‚¹
* åˆ©ç”¨`åˆ†ç±»`å¯ä»¥æ˜ç¡®å£°æ˜çš„æ¥å£ï¼Œè¿›è¡Œç¼–è¯‘æ£€æŸ¥ã€‚
* å®ç°æ–¹å¼æ¯”è¾ƒ`è½»é‡`ï¼Œæ˜“äºå¼€å‘è€…ç†è§£è°ƒç”¨ã€‚

### ç¼ºç‚¹
* å¦‚æœç»„ä»¶ç‰¹åˆ«å¤šï¼Œéœ€è¦å®šä¹‰ç‰¹åˆ«å¤šçš„`category`ï¼Œå¯¹äºå¼€å‘è€…æ„Ÿè§‰ä¸ŠåŠŸèƒ½å¾ˆé‡å¤ï¼Œè€Œä¸”`category`è¿‡å¤šå¯¹å¯åŠ¨é€Ÿåº¦ä¹Ÿæœ‰å½±å“ã€‚
* `category`ä¸­ä»ç„¶å¼•å…¥äº†`å­—ç¬¦ä¸²ç¡¬ç¼–ç `ï¼Œå†…éƒ¨ä½¿ç”¨å­—å…¸ä¼ å‚ï¼Œä¸€å®šç¨‹åº¦ä¸Šä¹Ÿå­˜åœ¨å’Œ`URL Scheme`è·¯ç”±ç›¸åŒçš„é—®é¢˜ã€‚
* å¦‚æœ`ModuleA`è°ƒç”¨`ModuleB`éœ€è¦å¼•å…¥`ModuleB`å®ç°çš„`category`ï¼ŒåŒæ ·å­˜åœ¨è€¦åˆã€‚
* å¦‚æœ`ModuleB`ä¿®æ”¹äº†`category`ä¸­çš„æ–¹æ³•ï¼Œ`ModuleA`ä¹Ÿéœ€è¦åŒæ­¥ä¿®æ”¹ã€‚

## Protocol - Class
è¯¥æ–¹æ¡ˆçš„ä»£è¡¨æ¡†æ¶å°±æ˜¯[BeeHive](https://github.com/alibaba/BeeHive)ï¼Œé‡‡ç”¨`AOP+æ‰©å±•Appç”Ÿå‘½å‘¨æœŸAPI`çš„å½¢å¼ï¼Œå°†ä¸šåŠ¡ã€åŸºç¡€åŠŸèƒ½ä»¥æ¨¡å—çš„æ–¹å¼ç‹¬ç«‹å‡ºæ¥ï¼Œè§£å†³å¤§å‹åº”ç”¨ä¸­æ¨¡å—é—´å¤æ‚çš„è°ƒç”¨ï¼Œæ¨¡å—ä¹‹é—´ä»¥Serviceå½¢å¼è°ƒç”¨å°†å¤æ‚é—®é¢˜åˆ‡åˆ†ï¼Œä»¥AOPæ–¹å¼æ¨¡å—åŒ–æœåŠ¡ã€‚
### BeeHiveæ ¸å¿ƒæ€æƒ³
* å„æ¨¡å—ä¹‹é—´ä»ç›´æ¥è°ƒç”¨æ”¹ä¸º`Service`å½¢å¼ï¼Œé¿å…äº†ç›´æ¥ä¾èµ–ã€‚
* Appç”Ÿå‘½å‘¨æœŸåˆ†å‘ï¼Œå°†è€¦åˆåœ¨`AppDelegate`ä¸­é€»è¾‘æ‹†åˆ†ï¼Œæ¯ä¸ªæ¨¡å—ä»¥å¾®åº”ç”¨å½¢å¼ç‹¬ç«‹å­˜åœ¨ã€‚

### BeeHiveæ¨¡å—æ³¨å†Œ
åœ¨`BeeHive`ä¸­ä¸»è¦æ˜¯é€šè¿‡`BHModuleManager`æ¥ç®¡ç†å„ä¸ªæ¨¡å—çš„ã€‚`BHModuleManager`ä¸­åªä¼šç®¡ç†å·²ç»è¢«æ³¨å†Œè¿‡çš„æ¨¡å—ã€‚      
`BeeHive`ä½“ç»Ÿäº†ä¸‰ç§ä¸åŒçš„æ³¨å†Œæ–¹å¼ï¼Œ`annotation`ã€`é™æ€plist`ã€`åŠ¨æ€æ³¨å†Œ`(+load)ã€‚Moduleã€Serviceä¹‹é—´æ²¡æœ‰å…³è”ï¼Œæ¯ä¸ªä¸šåŠ¡æ¨¡å—å¯ä»¥å•ç‹¬å®ç°`Module`æˆ–è€…`Service`åŠŸèƒ½ã€‚

#### Annotationæ–¹å¼æ³¨å†Œ
ä½¿ç”¨`@BeeHiveService`è¿›è¡ŒAnnotationæ ‡è®°ã€‚`BeeHiveService`çº¢ç‚¹ä»¥å¦‚ä¸‹ï¼š
```
#define BeeHiveService(servicename,impl) \
class BeeHive; char * k##servicename##_service BeeHiveDATA(BeehiveServices) = "{ \""#servicename"\" : \""#impl"\"}";

#define BeeHiveDATA(sectname) __attribute((used, section("__DATA,"#sectname"")))
```
åœ¨ç¤ºä¾‹ä¸­ï¼Œ`@BeeHiveService(HomeServiceProtocol,BHViewController)`åœ¨é¢„ç¼–è¯‘ç»“æŸåä¼šå®Œå…¨å±•å¼€æˆå¦‚ä¸‹æ‰€ç¤ºï¼š
```
@class BeeHive; char * kHomeServiceProtocol_service __attribute((used, section("__DATA,""BeehiveServices"""))) = "{ \"""HomeServiceProtocol""\" : \"""BHViewController""\"}â€;
```
å…³äº__attributeçš„ç”¨æ³•ï¼Œå¯å‚è€ƒ[attribute](https://liumh.com/2018/08/18/ios-attribute-section/)        
__attributeç¬¬ä¸€ä¸ªå‚æ•°used,å®ƒçš„ä½œç”¨æ˜¯å‘Šè¯‰ç¼–è¯‘å™¨ï¼Œæˆ‘å£°æ˜çš„è¿™ä¸ªç¬¦å·æ˜¯éœ€è¦ä¿ç•™çš„ã€‚è¢«usedä¿®é¥°ä»¥åï¼Œæ„å‘³ç€å³ä½¿å‡½æ•°æ²¡æœ‰è¢«å¼•ç”¨ï¼Œåœ¨Releaseä¸‹ä¹Ÿä¸ä¼šè¢«ä¼˜åŒ–ã€‚å¦‚æœä¸åŠ è¿™ä¸ªä¿®é¥°ï¼Œé‚£ä¹ˆReleaseç¯å¢ƒé“¾æ¥å™¨ä¼šå»æ‰æ²¡æœ‰è¢«å¼•ç”¨çš„æ®µã€‚
    æœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦æŒ‡å®šä¸€ä¸ªç‰¹æ®Šçš„æ®µï¼Œæ¥å­˜æ”¾æˆ‘ä»¬æƒ³è¦çš„æ•°æ®ã€‚è¿™é‡Œæˆ‘ä»¬å°±æŠŠæ•°æ®å­˜åœ¨__DATAæ•°æ®æ®µé‡Œé¢çš„"BeehiveMods"sectionä¸­ã€‚ Attributesçš„ä¿®é¥°å…³é”®å­—section ("section-nameâ€)å¯ä»¥è¾¾åˆ°æ­¤è¦æ±‚ã€‚      
      
è¿™é‡Œå…ˆä»‹ç»ä¸€ä¸‹`__attribute__((constructor))`ï¼š

constructorï¼šé¡¾åæ€ä¹‰ï¼Œæ„é€ å™¨åŠ ä¸Šè¿™ä¸ªå±æ€§çš„å‡½æ•°ä¼šåœ¨å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆæˆ– shared libraryï¼‰loadæ—¶è¢«è°ƒç”¨ï¼Œå¯ä»¥ç†è§£ä¸ºåœ¨ main() å‡½æ•°è°ƒç”¨å‰æ‰§è¡Œï¼š
```
__attribute__((constructor))
static void beforeMain(void) {
    NSLog(@"beforeMain");
}
__attribute__((destructor))
static void afterMain(void) {
    NSLog(@"afterMain");
}
int main(int argc, const char * argv[]) {
    NSLog(@"main");
    return 0;
}

// Console:
// "beforeMain" -> "main" -> â€œafterMain"
```
`_dyld_register_func_for_add_image`:è¿™ä¸ªå‡½æ•°æ˜¯ç”¨æ¥æ³¨å†Œå›è°ƒï¼Œå½“dyldé“¾æ¥ç¬¦å·æ—¶ï¼Œè°ƒç”¨æ­¤å›è°ƒå‡½æ•°ã€‚åœ¨dyldåŠ è½½é•œåƒæ—¶ï¼Œä¼šæ‰§è¡Œæ³¨å†Œè¿‡çš„å›è°ƒå‡½æ•°ï¼›      

å¯¹äºæ¯ä¸€ä¸ªå·²ç»å­˜åœ¨çš„é•œåƒï¼Œå½“å®ƒè¢«åŠ¨æ€é“¾æ¥æ—¶ï¼Œéƒ½ä¼šæ‰§è¡Œå›è°ƒvoid (*func)(const struct mach_header* mh, intptr_t vmaddr_slide)ï¼Œä¼ å…¥æ–‡ä»¶çš„mach_headerä»¥åŠä¸€ä¸ªè™šæ‹Ÿå†…å­˜åœ°å€ intptr_tã€‚
```
__attribute__((constructor))
void initProphet() {
    _dyld_register_func_for_add_image(dyld_callback);
}

static void dyld_callback(const struct mach_header *mhp, intptr_t vmaddr_slide)
{
    NSArray *mods = BHReadConfiguration(BeehiveModSectName, mhp);
    for (NSString *modName in mods) {
        Class cls;
        if (modName) {
            cls = NSClassFromString(modName);
            
            if (cls) {
                [[BHModuleManager sharedManager] registerDynamicModule:cls];
            }
        }
    }
}


NSArray<NSString *>* BHReadConfiguration(char *sectionName,const struct mach_header *mhp)
{
    NSMutableArray *configs = [NSMutableArray array];
    unsigned long size = 0;
#ifndef __LP64__
    uintptr_t *memory = (uintptr_t*)getsectiondata(mhp, SEG_DATA, sectionName, &size);
#else
    const struct mach_header_64 *mhp64 = (const struct mach_header_64 *)mhp;
    uintptr_t *memory = (uintptr_t*)getsectiondata(mhp64, SEG_DATA, sectionName, &size);
#endif
    
    unsigned long counter = size/sizeof(void*);
    for(int idx = 0; idx < counter; ++idx){
        char *string = (char*)memory[idx];
        NSString *str = [NSString stringWithUTF8String:string];
        if(!str)continue;
        
        BHLog(@"config = %@", str);
        if(str) [configs addObject:str];
    }
    
    return configs;
}
```
mach_headeræ˜¯å®šä¹‰åœ¨`usr/include/mach-o/loader.h`ä¸­çš„æ•°æ®ç»“æ„ï¼š
```
/*
 * The 64-bit mach header appears at the very beginning of object files for
 * 64-bit architectures.
 */
struct mach_header_64 {
     uint32_t    magic;        /* mach magic number identifier */
     cpu_type_t    cputype;    /* cpu specifier */
     cpu_subtype_t    cpusubtype;    /* machine specifier */
     uint32_t    filetype;    /* type of file */
     uint32_t    ncmds;        /* number of load commands */
     uint32_t    sizeofcmds;    /* the size of all the load commands */
     uint32_t    flags;        /* flags */
     uint32_t    reserved;    /* reserved */
};
```
#### plistæ–¹å¼æ³¨å†Œ
éœ€è¦è®¾ç½®æœ¬åœ°plistæ–‡ä»¶è·¯å¾„ç»™`BeeHive`æ¡†æ¶è¯»å–ã€‚
```
//AppDelegate.m
[BHContext shareInstance].serviceConfigName = @"BeeHive.bundle/BHServiceâ€;
```
æ³¨å†Œplistæ—¶æœºï¼š
```// AppDelegate.m
- (BOOL)application:(UIApplication *)application didFinishLaunchingWithOptions:(NSDictionary *)launchOptions {
    
    
    [BHContext shareInstance].application = application;
    [BHContext shareInstance].launchOptions = launchOptions;
    [BHContext shareInstance].moduleConfigName = @"BeeHive.bundle/BeeHive";//å¯é€‰ï¼Œé»˜è®¤ä¸ºBeeHive.bundle/BeeHive.plist
    [BHContext shareInstance].serviceConfigName = @"BeeHive.bundle/BHService";
    
    [BeeHive shareInstance].enableException = YES;
    [[BeeHive shareInstance] setContext:[BHContext shareInstance]];
    [[BHTimeProfiler sharedTimeProfiler] recordEventTime:@"BeeHive::super start launch"];
    
    [super application:application didFinishLaunchingWithOptions:launchOptions];
    
...
    
    return YES;
}

// BeeHive.m
-(void)setContext:(BHContext *)context
{
    _context = context;
    
    static dispatch_once_t onceToken;
    dispatch_once(&onceToken, ^{
        [self loadStaticServices];
        [self loadStaticModules];
    });
}

-(void)loadStaticServices
{
    [BHServiceManager sharedManager].enableException = self.enableException;
    
    [[BHServiceManager sharedManager] registerLocalServices];
    
}
```
æ³¨å†Œserviceçš„å…·ä½“å®ç°å¦‚ä¸‹ï¼š   
```
- (void)registerLocalServices
{
    NSString *serviceConfigName = [BHContext shareInstance].serviceConfigName;
    
    NSString *plistPath = [[NSBundle mainBundle] pathForResource:serviceConfigName ofType:@"plist"];
    if (!plistPath) {
        return;
    }
    
    NSArray *serviceList = [[NSArray alloc] initWithContentsOfFile:plistPath];
    
    [self.lock lock];
    for (NSDictionary *dict in serviceList) {
        NSString *protocolKey = [dict objectForKey:@"service"];
        NSString *protocolImplClass = [dict objectForKey:@"impl"];
        if (protocolKey.length > 0 && protocolImplClass.length > 0) {
            [self.allServicesDict addEntriesFromDictionary:@{protocolKey:protocolImplClass}];
        }
    }
    [self.lock unlock];
}
```
æ³¨å†Œå®Œæˆä¹‹åï¼ŒallServicesDictä¸­çš„å€¼å¦‚ä¸‹ï¼š    
```
{@"HomeServiceProtocol" : @"BHViewController", @"UserTrackServiceProtocol" : @"BHUserTrackViewController"}

```
#### APIæ³¨å†Œï¼ˆ+loadï¼‰
åœ¨`+load`æ–¹æ³•é‡Œé¢æ³¨å†Œ`Protocol`åè®®ï¼Œä¸»è¦æ˜¯è°ƒç”¨`BeeHive`é‡Œé¢çš„`registerService:service:`å®Œæˆ`protocol`çš„æ³¨å†Œ
```
+ (void)load
{
   [[BeeHive shareInstance] registerService:@protocol(UserTrackServiceProtocol) service:[BHUserTrackViewController class]];
}
ğŸ‘‡
- (void)registerService:(Protocol *)proto service:(Class) serviceClass
{
    [[BHServiceManager sharedManager] registerService:proto implClass:serviceClass];
}
```
## å‚è€ƒ
[iOSï¼šç»„ä»¶åŒ–çš„ä¸‰ç§é€šè®¯æ–¹æ¡ˆ](https://juejin.cn/post/7067743813099323423#heading-9)
[é˜¿é‡Œç»„ä»¶åŒ–æ¡†æ¶BeeHiveè§£æ](https://juejin.cn/post/6844903705834160136#heading-11)
[BeeHive](https://github.com/alibaba/BeeHive/blob/master/README-CN.md)